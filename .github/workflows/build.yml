name: Build and test

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
        inputs:
            build-images:
                description: 'Force re-build of all Docker images.'
                required: false
                type: boolean
                default: false
    schedule:
        # At 06:00 on Sunday.
        - cron:  '0 6 * * 6'
    release:
        types: [published]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
    contents: read
    packages: read

jobs:

    setup-skips:
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: alpine/git:2.49.1@sha256:26f8647ec43523c2511b99064cb45b48f4535bce956b9377a94b289fb021e819
        outputs:
            build-images: ${{ steps.build-images.outputs.build-images }}
            setup-job-matrix-image: ${{ steps.setup-job-matrix-image.outputs.setup-job-matrix-image }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            # Images generally need a rebuild either because of file changes or it was requested during the workflow dispatch.
            # Otherwise, the jobs can be skipped, thus speeding up the workflow.

            # For the 'setup-job-matrix-image' job.
            - id: setup-job-matrix-image-extract-mounts
              run: sh .github/workflows/extract-mounts.sh docker/dockerfile.setup-job-matrix

            - id: setup-job-matrix-image-changed-files
              uses: tj-actions/changed-files@v47
              with:
                  files: |
                      docker/**
                      .github/workflows/**
                      ${{ steps.setup-job-matrix-image-extract-mounts.outputs.paths }}

            - id: setup-job-matrix-image
              env:
                  ANY_CHANGED: ${{ steps.setup-job-matrix-image-changed-files.outputs.any_changed == 'true' }}
                  FORCE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs['build-images'] }}
              run: |
                  if [ "$ANY_CHANGED" = "true" ] || [ "$FORCE" = "true" ]; then
                      SETUP_JOB_MATRIX_IMAGE=true
                  else
                      SETUP_JOB_MATRIX_IMAGE=false
                  fi
                  echo "SETUP_JOB_MATRIX_IMAGE set to ${SETUP_JOB_MATRIX_IMAGE} because:"
                  echo "    - any changed: ${ANY_CHANGED}"
                  echo "    - force      : ${FORCE}"
                  echo "setup-job-matrix-image=${SETUP_JOB_MATRIX_IMAGE}" >> $GITHUB_OUTPUT

            # For the 'build-images' job.
            - id: build-images-extract-mounts
              run: sh .github/workflows/extract-mounts.sh docker/dockerfile docker/dockerfile.kokkos

            - id: build-images-changed-files
              uses: tj-actions/changed-files@v47
              with:
                  files: |
                      docker/**
                      .github/workflows/**
                      ${{ steps.build-images-extract-mounts.outputs.paths }}

            - id: build-images
              env:
                  ANY_CHANGED: ${{ steps.build-images-changed-files.outputs.any_changed == 'true' }}
                  FORCE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs['build-images'] }}
              run: |
                  if [ "$ANY_CHANGED" = "true" ] || [ "$FORCE" = "true" ]; then
                      BUILD_IMAGES=true
                  else
                      BUILD_IMAGES=false
                  fi
                  echo "BUILD_IMAGES set to ${BUILD_IMAGES} because:"
                  echo "    - any changed: ${ANY_CHANGED}"
                  echo "    - force      : ${FORCE}"
                  echo "build-images=${BUILD_IMAGES}" >> $GITHUB_OUTPUT

    setup-job-matrix-image:
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: docker:latest
        permissions:
            contents: read
            packages: write
        needs: [setup-skips]
        if: ${{ needs.setup-skips.outputs.setup-job-matrix-image == 'true' }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/setup-buildx-action@v3

            - uses: docker/build-push-action@v6.19.2
              with:
                  context: .
                  platforms: linux/amd64
                  push: ${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs['build-images']) }}
                  file: docker/dockerfile.setup-job-matrix
                  tags: ghcr.io/${{ github.repository }}/setup-job-matrix:latest
                  cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/setup-job-matrix:latest
                  cache-to: type=inline
                  labels: "org.opencontainers.image.source=${{ github.repositoryUrl }}"

    setup-job-matrix:
        runs-on: [self-hosted, linux, docker, amd64]
        needs: [setup-job-matrix-image]
        container:
            image: ghcr.io/${{ github.repository }}/setup-job-matrix:latest
        outputs:
            deploy_image: ${{ steps.strategy.outputs.deploy_image }}
            doc_image: ${{ steps.strategy.outputs.doc_image }}
            matrix_examples: ${{ steps.strategy.outputs.matrix_examples }}
            matrix_images: ${{ steps.strategy.outputs.matrix_images }}
            matrix_tests: ${{ steps.strategy.outputs.matrix_tests }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - id  : strategy
              run : |
                  PYTHONPATH=$PWD python .github/workflows/strategy.py \
                      --registry=ghcr.io \
                      --repository=${{ github.repository }} >> $GITHUB_OUTPUT

    build-images-image:
        needs: [setup-skips]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: docker:latest
        permissions:
            contents: read
            packages: write
        if: ${{ needs.setup-skips.outputs.build-images == 'true' }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/setup-qemu-action@v3

            - uses: docker/setup-buildx-action@v3

            - uses: docker/build-push-action@v6.19.2
              with:
                  context: null
                  platforms: linux/amd64,linux/arm64
                  push: ${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs['build-images']) }}
                  file: docker/dockerfile.build-images
                  tags: ghcr.io/${{ github.repository }}/build-images:latest
                  cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/build-images:latest
                  cache-to: type=inline
                  labels: "org.opencontainers.image.source=${{ github.repositoryUrl }}"

    build-images:
        needs: [setup-job-matrix, build-images-image, setup-skips]
        runs-on: ${{ matrix.build-images.runs-on }}
        container:
            image: ghcr.io/${{ github.repository }}/build-images:latest
        services:
            docker:
                image: docker:dind
        permissions:
            contents: read
            packages: write
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix_images) }}
        env: ${{ matrix.environment }}
        name: build-images (${{ matrix.name }})
        if: ${{ ! failure() && ! cancelled() && needs.setup-skips.outputs.build-images == 'true' }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/setup-buildx-action@v3

            - uses: docker/build-push-action@v6.19.2
              with:
                  context: .
                  platforms: ${{ matrix.platform }}
                  push: ${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs['build-images']) }}
                  file: docker/dockerfile
                  tags: ${{ matrix.image }}
                  cache-from: type=registry,ref=${{ matrix.image }}
                  cache-to: type=inline
                  build-args: |
                      BASE_IMAGE=${{ matrix.base_image }}
                      CXX_COMPILER_ID=${{ matrix.compilers.CXX.ID_lower }}
                      CXX_COMPILER_VERSION=${{ matrix.compilers.CXX.version }}
                      CXX_COMPILER=${{ matrix.compilers.CXX.path }}
                      DOXYGEN_VERSION=1_14_0
                      GOOGLEBENCHMARK_VERSION=1.9.4
                      NVTX3_VERSION=3.4.0
                      PYTHON_VERSION=${{ matrix.python_version }}
                      RUST_VERSION=1.92.0
                  labels: "org.opencontainers.image.source=${{ github.repositoryUrl }}"

            - uses: docker/build-push-action@v6.19.2
              if  : ${{ matrix.build_image_examples }}
              with:
                  context: .
                  platforms: ${{ matrix.platform }}
                  push: true #${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs['build-images']) }}
                  file: docker/dockerfile.kokkos
                  tags: ${{ matrix.kokkos }}
                  cache-from: type=registry,ref=${{ matrix.kokkos }}
                  cache-to: type=inline
                  build-args: |
                      BASE_IMAGE=${{ matrix.image }}
                      KOKKOS_ARCH=${{ matrix.nvidia_arch }}
                      KOKKOS_CXX_COMPILER=${{ matrix.compilers.CXX.path }}
                      KOKKOS_CUDA_COMPILER=${{ matrix.compilers.CUDA.path }}
                      KOKKOS_INSTALL_SUFFIX=${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}
                      KOKKOS_SHA=${{ matrix.kokkos_sha }}
                      KOKKOS_TOOLS_INSTALL_SUFFIX=${{ matrix.cmake_preset }}
                      KOKKOS_TOOLS_SHA=6493964271d2e887432489f20559b72757db02b0
                  labels: "org.opencontainers.image.source=${{ github.repositoryUrl }}"

    tests:
        needs: [setup-job-matrix, build-images]
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix_tests) }}
        env: ${{ matrix.environment }}
        name: tests (${{ matrix.name }})
        runs-on: ${{ matrix.tests.runs-on }}
        container: ${{ matrix.tests.container }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - run: |
                cmake -S . --preset=${{ matrix.cmake_preset }} \
                    -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cmake_cuda_architectures }} \
                    -DReProspect_ENABLE_COVERAGE=ON \
                    -DReProspect_ENABLE_DOCS=OFF \
                    -DReProspect_ENABLE_EXAMPLES=OFF \
                    -DReProspect_ENABLE_TESTS=ON

            - run: cmake --build --preset=${{ matrix.cmake_preset }}

            - run: ctest --preset=${{ matrix.cmake_preset }}

            - run: |
                test ! -f .coverage
                coverage combine --keep $(find coverage/ -type f -name "*.cov")
                coverage report
                test -f .coverage
                mv .coverage coverage.${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}

            - uses: actions/upload-artifact@v6
              with:
                  name: tests-${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}
                  path: artifacts
                  retention-days: 1
                  if-no-files-found: error

            - uses: actions/upload-artifact@v6
              with:
                  name: tests-coverage-${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}
                  path: coverage.${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}
                  retention-days: 1
                  if-no-files-found: error

    build-package:
        needs: [setup-job-matrix, build-images, mypy]
        runs-on: ${{ matrix.runs-on }}
        strategy:
            fail-fast: false
            matrix:
                pyver: [cp310, cp311, cp312, cp313, cp314]
                build: [manylinux_x86_64, manylinux_aarch64, win_amd64]
                include:
                    - runs-on: ubuntu-24.04
                      build: manylinux_x86_64
                    - runs-on: ubuntu-24.04-arm
                      build: manylinux_aarch64
                    - runs-on: windows-latest
                      build: win_amd64
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6
            - uses: actions/setup-python@v6
              with:
                  python-version: '3.11'
            - run: python -m pip install -U cibuildwheel
            - run: python -m cibuildwheel --config-file pyproject.toml --output-dir wheelhouse
              env:
                  CIBW_BUILD: "${{ matrix.pyver }}-${{ matrix.build }}"
            - uses: actions/upload-artifact@v6
              with:
                  name: package-${{ matrix.pyver }}-${{ matrix.build }}
                  path: wheelhouse/
                  retention-days: 1
                  if-no-files-found: error

    build-package-sdist:
        needs: []
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: ubuntu:24.04
        steps:
            - uses: actions/checkout@v6
            - uses: actions/setup-python@v6
              with:
                  python-version: '3.11'
            - run: python -m pip install -U build
            - run: python -m build --sdist --verbose --outdir wheelhouse .
            - uses: actions/upload-artifact@v6
              with:
                  name: package-sdist
                  path: wheelhouse/
                  retention-days: 1
                  if-no-files-found: error

    examples:
        needs: [
            setup-job-matrix,
            build-images,
            build-package,
            build-package-sdist,
        ]
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix_examples) }}
        env: ${{ matrix.environment }}
        name: examples (${{ matrix.name }})
        runs-on: ${{ matrix.examples.runs-on }}
        container: ${{ matrix.examples.container }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/download-artifact@v7
              with:
                  pattern: package-*
                  path: wheelhouse
                  merge-multiple: true

            - name: Install the package.
              run : |
                tree wheelhouse/
                python -m pip install --no-deps --no-index --find-links=wheelhouse/ reprospect

            - name: Print version and import.
              run: |
                python -m pip show reprospect
                python -c "import reprospect; print(reprospect);"
                python -c "from reprospect.utils.detect import GPUDetector as u; print(u.get())"

            - name: Scripts.
              run: |
                reprospect-install-nsight-systems --help

            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
            - run: test -d reprospect && rm -rf reprospect

            - run: |
                cmake -S . --preset=${{ matrix.cmake_preset }} \
                    -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cmake_cuda_architectures }} \
                    -DReProspect_ENABLE_DOCS=OFF \
                    -DReProspect_ENABLE_EXAMPLES=ON \
                    -DReProspect_ENABLE_TESTS=OFF

            - run: cmake --build --preset=${{ matrix.cmake_preset }}

            - run: ctest --preset=${{ matrix.cmake_preset }}

            - uses: actions/upload-artifact@v6
              with:
                  name: examples-${{ matrix.cmake_preset }}-${{ matrix.nvidia_arch }}
                  path: artifacts
                  retention-days: 1

    coverage:
        needs: [
            setup-job-matrix,
            build-images,
            tests,
        ]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: ${{ needs.setup-job-matrix.outputs.doc_image }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6

            - uses: actions/download-artifact@v7
              with:
                  pattern: tests-coverage-*
                  path: coverage-data
                  merge-multiple: true

            - run: |
                coverage combine --keep $(find coverage-data -type f)
                coverage report --data-file=.coverage --fail-under=95
                coverage html   --data-file=.coverage --directory=htmlcoverage

            - uses: actions/upload-artifact@v6
              with:
                  name: tests-coverage
                  path: htmlcoverage/
                  retention-days: 1
                  if-no-files-found: error

    documentation:
        needs: [
            setup-job-matrix,
            build-images,
            tests,
            examples
        ]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: ${{ needs.setup-job-matrix.outputs.doc_image }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - run: |
                cmake -S . --preset=gnu-nvidia \
                    -DReProspect_ENABLE_DOCS=ON \
                    -DReProspect_ENABLE_EXAMPLES=ON \
                    -DReProspect_ENABLE_TESTS=ON
                cmake --build . --preset=gnu-nvidia --target=docs

            - uses: actions/download-artifact@v7
              with:
                  name: tests-gnu-nvidia-BLACKWELL120
                  path: artifacts

            - uses: actions/download-artifact@v7
              with:
                  name: examples-gnu-nvidia-BLACKWELL120
                  path: artifacts

            - run: cd docs && make -j4 doctest
            - run: cd docs && make -j4 html

            - uses: actions/upload-pages-artifact@v4
              with:
                  path: docs/build/html

    papers:
        needs: []
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: openjournals/inara
        steps:
            - run: apk add git

            - uses: actions/checkout@v6
            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - id: changed-files
              uses: tj-actions/changed-files@v47
              with:
                  files: |
                      papers/joss/**

            - if : steps.changed-files.outputs.any_changed == 'true'
              run: |
                cd papers/joss/2025
                inara -o pdf -p -v paper.md

            - if: steps.changed-files.outputs.any_changed == 'true'
              uses: actions/upload-artifact@v6
              with:
                  name: papers
                  path: papers/**/*.pdf
                  retention-days: 1
                  if-no-files-found: error

    pylint:
        runs-on: [self-hosted, linux, docker, amd64]
        needs: [setup-job-matrix, build-images]
        container:
            image: ${{ needs.setup-job-matrix.outputs.deploy_image }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6

            - name: On the sources.
              run: |
                python3 -m pylint reprospect/ \
                    --rcfile pyproject.toml \
                    --verbose

            - name: On the tests.
              run: |
                export PYTHONPATH=$PWD${PYTHONPATH+:}${PYTHONPATH}
                python3 -m pylint tests/ \
                    --rcfile tests/.pylintrc \
                    --verbose \
                    --fail-under=10

            - name: On the examples.
              run: |
                export PYTHONPATH=$PWD${PYTHONPATH+:}${PYTHONPATH}
                python3 -m pylint examples \
                    --rcfile tests/.pylintrc \
                    --verbose \
                    --fail-under=10

    mypy:
        runs-on: [self-hosted, linux, docker, amd64]
        needs: [setup-job-matrix, build-images]
        container:
            image: ${{ needs.setup-job-matrix.outputs.deploy_image }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6

            - name: On the strategy.
              run: |
                export PYTHONPATH="$PWD${PYTHONPATH+:}${PYTHONPATH}"
                mypy --strict --follow-untyped-import .github/workflows/strategy.py

            - name: On the sources.
              run: |
                mypy --config-file pyproject.toml

            - name: On the tests.
              run: |
                export PYTHONPATH="$PWD${PYTHONPATH+:}${PYTHONPATH}"
                mypy --config-file tests/.mypy.ini --explicit-package-bases tests

            - name: On the examples.
              run: |
                export PYTHONPATH="$PWD${PYTHONPATH+:}${PYTHONPATH}"
                mypy --config-file tests/.mypy.ini --explicit-package-bases examples

    ruff:
        runs-on: [self-hosted, linux, docker, amd64]
        needs: [setup-job-matrix, build-images]
        container:
            image: ${{ needs.setup-job-matrix.outputs.deploy_image }}
        if: ${{ ! failure() && ! cancelled() }}
        steps:
            - uses: actions/checkout@v6
            - run: ruff check --config pyproject.toml

    deploy:
        needs: [
            setup-job-matrix,
            build-images,
            build-package,
            build-package-sdist,
            documentation,
            examples,
            mypy,
            pylint,
            ruff,
            tests,
        ]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: ubuntu:24.04
        if: ${{ ! failure() && ! cancelled() && github.ref == 'refs/heads/main' }}

        permissions:
            pages   : write
            id-token: write

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - id  : deployment
              uses: actions/deploy-pages@v4

    # Following instructions from
    # https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/#publishing-the-distribution-to-pypi.
    publish-to-pypi:
        needs: [
            setup-job-matrix,
            build-images,
            build-package,
            build-package-sdist,
            documentation,
            examples,
            mypy,
            pylint,
            ruff,
            tests,
        ]
        runs-on: ubuntu-latest

        if: ${{ ! failure() && ! cancelled() && github.event_name == 'release' && github.event.action == 'published' }}

        environment:
            name: pypi
            url: https://pypi.org/p/reprospect

        permissions:
            id-token: write
            packages: read

        steps:
            - uses: actions/download-artifact@v7
              with:
                  pattern: package-*
                  path: wheelhouse
                  merge-multiple: true

            - uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: wheelhouse
                  verbose: true
