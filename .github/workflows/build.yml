name: Build and test

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
    schedule:
        # At 06:00 on Sunday.
        - cron:  '0 6 * * 6'

jobs:

    setup-job-matrix:
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: python:3.12
        outputs:
            deploy_image: ${{ steps.strategy.outputs.deploy_image }}
            environment: ${{ steps.strategy.outputs.environment }}
            matrix: ${{ steps.strategy.outputs.matrix }}
        steps:
            - uses: actions/checkout@v5
            - id  : strategy
              run : |
                  python .github/workflows/strategy.py --registry=ghcr.io --repository=${{ github.repository }} >> $GITHUB_OUTPUT

    build-image:
        needs: [setup-job-matrix]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: docker:latest
        permissions:
            contents: read
            packages: write
            pull-requests: read
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix) }}
        env: ${{ fromJSON(needs.setup-job-matrix.outputs.environment) }}
        steps:
            - uses: actions/checkout@v5
              with:
                  set-safe-directory: true

            - run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - id: changed-files
              uses: tj-actions/changed-files@v47
              with:
                  files: |
                      docker/dockerfile
                      .github/workflows/**

            - uses: docker/login-action@v3
              if  : steps.changed-files.outputs.any_changed == 'true'
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/setup-buildx-action@v3
              if  : steps.changed-files.outputs.any_changed == 'true'

            - uses: docker/build-push-action@v6.18.0
              if  : steps.changed-files.outputs.any_changed == 'true'
              with:
                  context: .
                  platforms: linux/amd64
                  push: ${{ github.ref == 'refs/heads/main' }}
                  file: docker/dockerfile
                  tags: ${{ matrix.image }}
                  cache-from: type=registry,ref=${{ matrix.image }}
                  cache-to: type=inline
                  build-args: |
                      BASE_IMAGE=${{ matrix.base_image }}
                      COMPILER=${{ matrix.compiler_family[0][0] }}
                      COMPILER_VERSION=${{ matrix.compiler_family[0][1] }}
                  labels: "org.opencontainers.image.source=${{ github.repositoryUrl }}"

    test:
        needs: [setup-job-matrix, build-image]
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix) }}
        env: ${{ fromJSON(needs.setup-job-matrix.outputs.environment) }}
        runs-on: ${{ matrix.runs-on }}
        container:
            image: ${{ matrix.image }}
        steps:
            - uses: actions/checkout@v5

            - run: |
                cmake -S . --preset=${{ matrix.cmake_preset }} \
                    -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_arch[1] }}

            - run: cmake --build --preset=${{ matrix.cmake_preset }}

            - run: ctest --preset=${{ matrix.cmake_preset }}

    install-as-package-and-test:
        needs: [setup-job-matrix, build-image]
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJSON(needs.setup-job-matrix.outputs.matrix) }}
        env: ${{ fromJSON(needs.setup-job-matrix.outputs.environment) }}
        runs-on: ${{ matrix.runs-on }}
        container:
            image: ${{ matrix.image }}
        steps:
            # Since it is still a private repository, let's avoid authentication burden by
            # installing from the files directly.
            - uses: actions/checkout@v5
              with:
                  path: install-from
            - run : |
                pip install install-from/
                rm -rf install-from/

            - run: |
                python -c "import cuda_helpers.tools.device_properties as u; print(u.Cuda().get_device_name(device = 0))"

            - run: |
                cuda-helpers-install-nsight-systems --help

    deploy:
        needs: [setup-job-matrix, test, install-as-package-and-test]
        runs-on: [self-hosted, linux, docker, amd64]
        container:
            image: ${{ needs.setup-job-matrix.outputs.deploy_image }}
        steps:
            - uses: actions/checkout@v5
            - run: |
                python -m pip install build
                python -m build
                ls
            - if: github.ref == 'refs/heads/main'
              run: |
                mc alias set MC_HOST_COSTMO ${{ vars.MC_HOST_COSTMO_URL }} ${{ secrets.MC_HOST_COSTMO_USER }} ${{ secrets.MC_HOST_COSTMO_PASSWORD }}
                mc mb --ignore-existing MC_HOST_COSTMO/cuda-helpers
                mc cp dist/cuda_helpers-$(awk -F"'" '/__version__/ {print $2}' cuda_helpers/__init__.py)-py3-none-any.whl MC_HOST_COSTMO/cuda-helpers/
